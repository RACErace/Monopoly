<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤§å¯Œç¿è”æœºç‰ˆ</title>
  <style>
    body {
      font-family: "å¾®è½¯é›…é»‘", sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    #board {
      width: 800px;
      height: 800px;
      margin: 20px auto;
      position: relative;
      background: #2e8b57;
      border: 10px solid #8b4513;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .tile {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 2px solid #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      text-align: center;
      padding: 4px;
    }

    .tile:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    /* è§’è½ç‰¹æ®Šæ ¼å­ */
    .corner-tile {
      position: absolute;
      width: 100px !important;
      height: 100px !important;
      border: 2px solid #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 12px !important;
      font-weight: bold;
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      background: linear-gradient(45deg, #ffd700, #ffed4e) !important;
      padding: 4px;
    }

    /* å³è¾¹ */
    .right-edge {
      right: 10px;
    }

    .right-0 {
      top: 10px;
    }

    /* å³ä¸Šè§’ */
    .right-1 {
      top: 120px;
    }

    .right-2 {
      top: 210px;
    }

    .right-3 {
      top: 300px;
    }

    .right-4 {
      top: 390px;
    }

    .right-5 {
      top: 480px;
    }

    .right-6 {
      top: 570px;
    }

    /* åº•è¾¹ */
    .bottom-edge {
      bottom: 10px;
    }

    .bottom-0 {
      right: 10px;
    }

    /* å³ä¸‹è§’ */
    .bottom-1 {
      right: 120px;
    }

    .bottom-2 {
      right: 210px;
    }

    .bottom-3 {
      right: 300px;
    }

    .bottom-4 {
      right: 390px;
    }

    .bottom-5 {
      right: 480px;
    }

    .bottom-6 {
      right: 570px;
    }

    /* å·¦è¾¹ */
    .left-edge {
      left: 10px;
    }

    .left-0 {
      bottom: 10px;
    }

    /* å·¦ä¸‹è§’ */
    .left-1 {
      bottom: 120px;
    }

    .left-2 {
      bottom: 210px;
    }

    .left-3 {
      bottom: 300px;
    }

    .left-4 {
      bottom: 390px;
    }

    .left-5 {
      bottom: 480px;
    }

    .left-6 {
      bottom: 570px;
    }

    /* é¡¶è¾¹ */
    .top-edge {
      top: 10px;
    }

    .top-0 {
      left: 10px;
    }

    /* å·¦ä¸Šè§’ */
    .top-1 {
      left: 120px;
    }

    .top-2 {
      left: 210px;
    }

    .top-3 {
      left: 300px;
    }

    .top-4 {
      left: 390px;
    }

    .top-5 {
      left: 480px;
    }

    .top-6 {
      left: 570px;
    }

    .player-token {
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-weight: bold;
      font-size: 10px;
      color: #000;
      background: rgba(255, 255, 255, 0.8);
      padding: 1px 3px;
      border-radius: 3px;
      min-width: 15px;
      text-align: center;
    }

    .property-name {
      font-weight: bold;
      font-size: 9px;
      margin-bottom: 2px;
      color: #333;
    }

    .property-info {
      font-size: 8px;
      line-height: 1.1;
      color: #666;
    }

    .property-price {
      font-weight: bold;
      color: #2e8b57;
      font-size: 9px;
    }

    .houses-indicator {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 8px;
      background: #4CAF50;
      color: white;
      padding: 1px 3px;
      border-radius: 2px;
    }

    /* ä¸­å¤®æ¸¸æˆä¿¡æ¯åŒºåŸŸ */
    #game-center {
      position: absolute;
      top: 150px;
      left: 150px;
      width: 500px;
      height: 500px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
    }

    #game-title {
      font-size: 24px;
      font-weight: bold;
      color: #2e8b57;
      margin-bottom: 20px;
    }

    #current-player {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #player-stats {
      margin-top: 20px;
      text-align: left;
      width: 100%;
    }

    .player-stat {
      margin: 5px 0;
      padding: 5px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
    }

    #controls {
      margin: 20px auto;
      text-align: center;
      max-width: 800px;
    }

    button {
      font-size: 14px;
      margin-right: 8px;
      padding: 6px 14px;
      cursor: pointer;
    }

    #log {
      white-space: pre-line;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
      height: 200px;
      overflow-y: auto;
      background: #fff;
      box-shadow: inset 0 0 5px #ddd;
    }

    #dice-container {
      perspective: 600px;
      width: 150px;
      height: 60px;
      margin: 10px auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 30px;
    }

    .dice {
      width: 60px;
      height: 60px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 1s ease-out;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .face {
      position: absolute;
      width: 60px;
      height: 60px;
      background: white;
      border: 2px solid #333;
      border-radius: 8px;
      font-size: 28px;
      text-align: center;
      line-height: 60px;
      font-weight: bold;
      -webkit-user-select: none;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .face1 {
      transform: rotateY(0deg) translateZ(30px);
    }

    .face2 {
      transform: rotateY(90deg) translateZ(30px);
    }

    .face3 {
      transform: rotateY(180deg) translateZ(30px);
    }

    .face4 {
      transform: rotateY(-90deg) translateZ(30px);
    }

    .face5 {
      transform: rotateX(90deg) translateZ(30px);
    }

    .face6 {
      transform: rotateX(-90deg) translateZ(30px);
    }

    /* ç©å®¶åˆ—è¡¨æ ·å¼ */
    .player-card {
      background: linear-gradient(145deg, #f8f9fa, #e9ecef);
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .player-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .player-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #333;
    }

    .player-host-badge {
      background: #ffd700;
      color: #333;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
    }

    .player-status {
      font-size: 10px;
      color: #666;
      margin-left: auto;
    }

    /* æˆ¿é—´ç­‰å¾…é¡µé¢æ ·å¼ */
    #lobby-page button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    #lobby-page input:focus {
      border-color: #2e8b57;
      outline: none;
      box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
    }

    /* æ¸¸æˆæ§åˆ¶æŒ‰é’®æ ·å¼ */
    #controls button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #2e8b57;
      color: white;
    }

    #controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: #245f3e;
    }

    #controls button:active {
      transform: translateY(0);
    }

    /* ç»“æŸå›åˆæŒ‰é’®ç‰¹æ®Šæ ·å¼ */
    #controls button[onclick="endTurn()"] {
      background: #f39c12;
      border: 2px solid #e67e22;
    }

    #controls button[onclick="endTurn()"]:hover {
      background: #e67e22;
      border-color: #d35400;
    }
  </style>
</head>

<body>

  <!-- æˆ¿é—´ç­‰å¾…é¡µé¢ -->
  <div id="lobby-page" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div style="background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 600px; width: 90%; text-align: center;">
      <h1 style="color: #2e8b57; margin-bottom: 30px; font-size: 2.5em;">ğŸ² å¤§å¯Œç¿è”æœºç‰ˆ ğŸ²</h1>
      
      <!-- åŠ å…¥æˆ¿é—´åŒºåŸŸ -->
      <div id="join-section">
        <div style="margin-bottom: 20px;">
          <label for="name" style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">ç©å®¶åå­—ï¼š</label>
          <input id="name" placeholder="è¾“å…¥ä½ çš„åå­—" autocomplete="name" 
                 style="width: 60%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center;" />
        </div>
        <button type="button" onclick="connect()" 
                style="background: #2e8b57; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s ease;">
          åŠ å…¥æˆ¿é—´
        </button>
      </div>

      <!-- é€€å‡ºæˆ¿é—´åŒºåŸŸ -->
      <div id="leave-section" style="display: none; margin-bottom: 20px;">
        <button type="button" onclick="leaveRoom()" 
                style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.3s ease;">
          é€€å‡ºæˆ¿é—´
        </button>
      </div>

      <!-- ç©å®¶åˆ—è¡¨åŒºåŸŸ -->
      <div id="player-list-container" style="display: none; margin-top: 30px;">
        <h3 style="margin: 0 0 20px 0; color: #2e8b57; border-bottom: 2px solid #2e8b57; padding-bottom: 10px;">æˆ¿é—´ç©å®¶åˆ—è¡¨</h3>
        
        <!-- é¢œè‰²é€‰æ‹©åŒºåŸŸ -->
        <div id="color-selection-container" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
          <h4 style="margin: 0 0 10px 0; color: #2e8b57;">é€‰æ‹©ä½ çš„é¢œè‰²</h4>
          <div id="color-options" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;"></div>
          <div id="selected-color-info" style="margin-top: 10px; font-size: 14px; color: #666; text-align: center;"></div>
        </div>
        
        <div id="player-list" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px;"></div>
        <div id="room-status" style="font-size: 14px; color: #666; margin-bottom: 20px;"></div>
        
        <!-- å¼€å§‹æ¸¸æˆæŒ‰é’® -->
        <button type="button" id="start-game-btn" onclick="startGame()" style="display: none; background: #e74c3c; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
          å¼€å§‹æ¸¸æˆ
        </button>
        
        <div style="margin-top: 15px; color: #888; font-size: 14px;">
          <p>ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...</p>
          <p>æœ€å°‘2äººï¼Œæœ€å¤š6äººå¯ä»¥å¼€å§‹æ¸¸æˆ</p>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆä¸»ç•Œé¢ -->
  <div id="game-page" style="display: none;">
    <div id="controls">
      <button type="button" onclick="rollDice()">æ·éª°å­</button>
      <button type="button" onclick="buy()">è´­ä¹°åœ°äº§</button>
      <button type="button" onclick="upgrade()">å‡çº§æˆ¿å±‹</button>
      <button type="button" onclick="showFinancialOptions()">è´¢åŠ¡ç®¡ç†</button>
      <button type="button" onclick="endTurn()" style="background: #f39c12; color: white;">ç»“æŸå›åˆ</button>
      <button type="button" onclick="showLobby()" style="background: #e74c3c; color: white;">è¿”å›æˆ¿é—´</button>
    </div>

  <!-- è´¢åŠ¡ç®¡ç†æ¨¡æ€æ¡† -->
  <div id="financial-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div
      style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:10px; max-width:600px; width:90%;">
      <h3>è´¢åŠ¡ç®¡ç†</h3>
      <div id="financial-content">
        <div>
          <h4>å¯æŠµæŠ¼çš„åœ°å—:</h4>
          <div id="mortgageable-list"></div>
        </div>
        <div>
          <h4>å¯èµå›çš„åœ°å—:</h4>
          <div id="redeemable-list"></div>
        </div>
        <div>
          <h4>å¯å‡ºå”®çš„åœ°å—:</h4>
          <div id="sellable-list"></div>
        </div>
      </div>
      <button onclick="closeFinancialModal()">å…³é—­</button>
    </div>
  </div>

  <div id="board">
    <!-- ä¸­å¤®æ¸¸æˆä¿¡æ¯åŒºåŸŸ -->
    <div id="game-center">
      <div id="game-title">ğŸ² å¤§å¯Œç¿è”æœºç‰ˆ ğŸ²</div>
      <div id="current-player">æ¬¢è¿æ¥åˆ°å¤§å¯Œç¿æ¸¸æˆï¼</div>
      <div id="dice-container">
        <div id="dice1" class="dice" onclick="rollDice()">
          <div class="face face1">1</div>
          <div class="face face2">2</div>
          <div class="face face3">3</div>
          <div class="face face4">4</div>
          <div class="face face5">5</div>
          <div class="face face6">6</div>
        </div>
        <div id="dice2" class="dice" onclick="rollDice()">
          <div class="face face1">1</div>
          <div class="face face2">2</div>
          <div class="face face3">3</div>
          <div class="face face4">4</div>
          <div class="face face5">5</div>
          <div class="face face6">6</div>
        </div>
      </div>
      <div id="player-stats"></div>
    </div>
  </div>

    <div id="log"></div>
  </div>

  <script>
    let ws, currentPlayer = null, gameData = null, isHost = false, roomPlayers = [], gameStarted = false;
    let playerColors = {}, availableColors = [], selectedColor = null;
    // é¢„å®šä¹‰æœ€å¤š6åç©å®¶çš„é¢œè‰²æ˜ å°„
    const predefinedColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd'];
    // éª°å­6é¢å¯¹åº”æ—‹è½¬è§’åº¦ (Xï¼ŒY)
    const diceRotations = {
      1: { x: 0, y: 0 },
      2: { x: 0, y: -90 },
      3: { x: 0, y: 180 },
      4: { x: 0, y: 90 },
      5: { x: 90, y: 0 },
      6: { x: -90, y: 0 }
    };

    // æ£‹ç›˜ä½ç½®æ˜ å°„ - ä»æœåŠ¡å™¨åŠ¨æ€è·å–
    let boardPositions = [];

    // æ£‹ç›˜ä½ç½®CSSç±»æ˜ å°„ - é¢„å®šä¹‰28ä¸ªä½ç½®çš„CSSç±»
    const positionClasses = [
      'corner-tile right-edge right-0',  // 0 - å³ä¸Šè§’
      'tile right-edge right-1',         // 1
      'tile right-edge right-2',         // 2
      'tile right-edge right-3',         // 3
      'tile right-edge right-4',         // 4
      'tile right-edge right-5',         // 5
      'tile right-edge right-6',         // 6
      'corner-tile bottom-edge bottom-0', // 7 - å³ä¸‹è§’
      'tile bottom-edge bottom-1',        // 8
      'tile bottom-edge bottom-2',        // 9
      'tile bottom-edge bottom-3',        // 10
      'tile bottom-edge bottom-4',        // 11
      'tile bottom-edge bottom-5',        // 12
      'tile bottom-edge bottom-6',        // 13
      'corner-tile left-edge left-0',     // 14 - å·¦ä¸‹è§’
      'tile left-edge left-1',            // 15
      'tile left-edge left-2',            // 16
      'tile left-edge left-3',            // 17
      'tile left-edge left-4',            // 18
      'tile left-edge left-5',            // 19
      'tile left-edge left-6',            // 20
      'corner-tile top-edge top-0',       // 21 - å·¦ä¸Šè§’
      'tile top-edge top-1',              // 22
      'tile top-edge top-2',              // 23
      'tile top-edge top-3',              // 24
      'tile top-edge top-4',              // 25
      'tile top-edge top-5',              // 26
      'tile top-edge top-6'               // 27
    ];

    // å¼‚æ­¥è·å–æ£‹ç›˜æ•°æ®
    async function loadBoardData() {
      try {
        const host = window.location.hostname || 'localhost';
        const port = window.location.port || '8000';
        const response = await fetch(`http://${host}:${port}/api/board-data`);
        const data = await response.json();
        
        // å°†æœåŠ¡å™¨æ•°æ®æ˜ å°„åˆ°å‰ç«¯æ ¼å¼
        boardPositions = data.board_data.map((tile, index) => ({
          pos: positionClasses[index] || 'tile',
          name: tile.name,
          prices: tile.price,
          special: tile.special || (tile.name === 'èµ·ç‚¹' || index === 0 || index === 7 || index === 14 || index === 21)
        }));
        
        log("æ£‹ç›˜æ•°æ®åŠ è½½å®Œæˆ");
        // åˆå§‹åŒ–æ£‹ç›˜æ˜¾ç¤º
        initializeBoard();
      } catch (error) {
        console.error("åŠ è½½æ£‹ç›˜æ•°æ®å¤±è´¥:", error);
        log("åŠ è½½æ£‹ç›˜æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®");
        // ä½¿ç”¨é»˜è®¤æ•°æ®ä½œä¸ºåå¤‡
        boardPositions = Array.from({length: 28}, (_, i) => ({
          pos: positionClasses[i] || 'tile',
          name: `ä½ç½®${i}`,
          prices: 100,
          special: i === 0 || i === 7 || i === 14 || i === 21
        }));
        initializeBoard();
      }
    }

    function log(msg) {
      const logDiv = document.getElementById('log');
      logDiv.textContent += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // é¢œè‰²é€‰æ‹©ç›¸å…³å‡½æ•°
    function chooseColor(color) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      
      ws.send(JSON.stringify({
        action: "choose_color",
        color: color
      }));
    }

    function renderColorOptions(availableColorsList, playerColorMap) {
      const colorOptionsDiv = document.getElementById('color-options');
      const selectedColorInfo = document.getElementById('selected-color-info');
      
      if (!colorOptionsDiv) return;
      
      colorOptionsDiv.innerHTML = '';
      
      // æ˜¾ç¤ºå½“å‰ç©å®¶å·²é€‰æ‹©çš„é¢œè‰²
      if (playerColorMap[currentPlayer]) {
        selectedColor = playerColorMap[currentPlayer];
        selectedColorInfo.innerHTML = `âœ… æ‚¨å·²é€‰æ‹©é¢œè‰²: <span style="display: inline-block; width: 20px; height: 20px; background: ${selectedColor}; border-radius: 50%; border: 2px solid #333; vertical-align: middle; margin-left: 5px;"></span>`;
      } else {
        selectedColorInfo.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªé¢œè‰²';
      }
      
      // æ¸²æŸ“é¢œè‰²é€‰é¡¹
      predefinedColors.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.style.width = '40px';
        colorOption.style.height = '40px';
        colorOption.style.borderRadius = '50%';
        colorOption.style.backgroundColor = color;
        colorOption.style.border = '3px solid #333';
        colorOption.style.cursor = 'pointer';
        colorOption.style.transition = 'all 0.3s ease';
        colorOption.style.display = 'flex';
        colorOption.style.alignItems = 'center';
        colorOption.style.justifyContent = 'center';
        colorOption.style.fontSize = '16px';
        
        // æ£€æŸ¥é¢œè‰²çŠ¶æ€
        const isOwned = Object.values(playerColorMap).includes(color);
        const isMyColor = playerColorMap[currentPlayer] === color;
        const isAvailable = availableColorsList.includes(color);
        
        if (isMyColor) {
          colorOption.innerHTML = 'âœ“';
          colorOption.style.color = 'white';
          colorOption.style.borderColor = '#2e8b57';
          colorOption.style.borderWidth = '4px';
          colorOption.style.transform = 'scale(1.1)';
        } else if (isOwned) {
          colorOption.innerHTML = 'âœ—';
          colorOption.style.color = 'white';
          colorOption.style.opacity = '0.5';
          colorOption.style.cursor = 'not-allowed';
          // æ˜¾ç¤ºå ç”¨è€…
          const owner = Object.keys(playerColorMap).find(player => playerColorMap[player] === color);
          colorOption.title = `å·²è¢« ${owner} é€‰æ‹©`;
        } else if (isAvailable) {
          colorOption.onclick = () => chooseColor(color);
          colorOption.onmouseover = () => {
            colorOption.style.transform = 'scale(1.2)';
            colorOption.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
          };
          colorOption.onmouseout = () => {
            colorOption.style.transform = 'scale(1)';
            colorOption.style.boxShadow = 'none';
          };
          colorOption.title = 'ç‚¹å‡»é€‰æ‹©æ­¤é¢œè‰²';
        }
        
        colorOptionsDiv.appendChild(colorOption);
      });
    }

    // é¡µé¢åˆ‡æ¢å‡½æ•°
    function showLobby() {
      document.getElementById('lobby-page').style.display = 'flex';
      document.getElementById('game-page').style.display = 'none';
      gameStarted = false;
    }

    function showGame() {
      document.getElementById('lobby-page').style.display = 'none';
      document.getElementById('game-page').style.display = 'block';
      gameStarted = true;
      
      // æ¸¸æˆå¼€å§‹åç«‹å³æ›´æ–°æ¸¸æˆä¸­å¿ƒæ˜¾ç¤º
      const currentPlayerDiv = document.getElementById('current-player');
      if (gameData && gameData.current_player) {
        currentPlayerDiv.textContent = `å½“å‰ç©å®¶: ${gameData.current_player}`;
      } else if (gameData && gameData.players && gameData.players.length > 0) {
        // å¦‚æœæ²¡æœ‰æŒ‡å®šå½“å‰ç©å®¶ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªç©å®¶
        const firstPlayer = gameData.players[0].name || gameData.players[0];
        currentPlayerDiv.textContent = `å½“å‰ç©å®¶: ${firstPlayer}`;
      } else {
        currentPlayerDiv.textContent = 'æ¸¸æˆå·²å¼€å§‹';
      }
      
      // æ¸¸æˆå¼€å§‹ååˆå§‹åŒ–æ£‹ç›˜å’Œç©å®¶çŠ¶æ€
      if (gameData) {
        if (gameData.players && gameData.properties) {
          renderBoard(gameData.players, gameData.properties);
        }
        if (gameData.players) {
          updatePlayerStats(gameData.players);
        }
      } else {
        initializeBoard();
      }
    }

    function updatePlayerList(players, hostPlayer, playerColorMap = {}, availableColorsList = []) {
      roomPlayers = players;
      isHost = hostPlayer === currentPlayer;
      playerColors = playerColorMap;
      availableColors = availableColorsList;

      // åªåœ¨æˆ¿é—´ç­‰å¾…é¡µé¢æ›´æ–°ç©å®¶åˆ—è¡¨
      if (!gameStarted) {
        const container = document.getElementById('player-list-container');
        const playerList = document.getElementById('player-list');
        const roomStatus = document.getElementById('room-status');
        const startGameBtn = document.getElementById('start-game-btn');

        // æ˜¾ç¤ºç©å®¶åˆ—è¡¨å®¹å™¨
        container.style.display = 'block';

        // æ¸²æŸ“é¢œè‰²é€‰æ‹©é€‰é¡¹
        renderColorOptions(availableColorsList, playerColorMap);

        // æ¸…ç©ºç°æœ‰åˆ—è¡¨
        playerList.innerHTML = '';

        // æ·»åŠ æ¯ä¸ªç©å®¶
        players.forEach((player, index) => {
          const playerCard = document.createElement('div');
          playerCard.className = 'player-card';
          playerCard.style.background = 'linear-gradient(145deg, #f8f9fa, #e9ecef)';
          playerCard.style.border = '2px solid #ddd';
          playerCard.style.borderRadius = '12px';
          playerCard.style.padding = '15px 20px';
          playerCard.style.display = 'flex';
          playerCard.style.alignItems = 'center';
          playerCard.style.gap = '12px';
          playerCard.style.fontSize = '16px';
          playerCard.style.fontWeight = 'bold';
          playerCard.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
          playerCard.style.transition = 'all 0.3s ease';
          playerCard.style.minWidth = '140px';

          const colorDot = document.createElement('div');
          colorDot.style.width = '16px';
          colorDot.style.height = '16px';
          colorDot.style.borderRadius = '50%';
          colorDot.style.border = '2px solid #333';
          // ä½¿ç”¨ç©å®¶é€‰æ‹©çš„é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
          const playerColor = playerColorMap[player] || predefinedColors[index] || '#cccccc';
          colorDot.style.backgroundColor = playerColor;

          const playerName = document.createElement('span');
          playerName.textContent = player;

          playerCard.appendChild(colorDot);
          playerCard.appendChild(playerName);

          // å¦‚æœç©å®¶æ²¡æœ‰é€‰æ‹©é¢œè‰²ï¼Œæ˜¾ç¤ºæç¤º
          if (!playerColorMap[player]) {
            const noColorBadge = document.createElement('span');
            noColorBadge.style.background = '#ff9800';
            noColorBadge.style.color = 'white';
            noColorBadge.style.fontSize = '10px';
            noColorBadge.style.padding = '2px 6px';
            noColorBadge.style.borderRadius = '10px';
            noColorBadge.style.marginLeft = 'auto';
            noColorBadge.textContent = 'æœªé€‰è‰²';
            playerCard.appendChild(noColorBadge);
          } else if (player === hostPlayer) {
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œæ·»åŠ æˆ¿ä¸»æ ‡è¯†
            const hostBadge = document.createElement('span');
            hostBadge.style.background = '#ffd700';
            hostBadge.style.color = '#333';
            hostBadge.style.fontSize = '12px';
            hostBadge.style.padding = '4px 8px';
            hostBadge.style.borderRadius = '10px';
            hostBadge.style.marginLeft = 'auto';
            hostBadge.textContent = 'æˆ¿ä¸»';
            playerCard.appendChild(hostBadge);
          }

          playerList.appendChild(playerCard);
        });

        // æ›´æ–°æˆ¿é—´çŠ¶æ€
        const allPlayersHaveColors = players.every(player => playerColorMap[player]);
        roomStatus.innerHTML = `
          <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2e8b57;">
            <div style="font-size: 16px; font-weight: bold; color: #2e8b57; margin-bottom: 5px;">
              æˆ¿é—´çŠ¶æ€: ${players.length}/6 äºº | é¢œè‰²é€‰æ‹©: ${Object.keys(playerColorMap).length}/${players.length}
            </div>
            <div style="color: #666;">
              æˆ¿ä¸»: ${hostPlayer} | ${players.length >= 2 && allPlayersHaveColors ? 'å¯ä»¥å¼€å§‹æ¸¸æˆ' : 'éœ€è¦è‡³å°‘2äººä¸”æ‰€æœ‰äººéƒ½é€‰æ‹©é¢œè‰²'}
            </div>
          </div>
        `;

        // åªæœ‰æˆ¿ä¸»èƒ½çœ‹åˆ°å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œä¸”äººæ•°>=2ä¸”æ‰€æœ‰äººéƒ½é€‰æ‹©äº†é¢œè‰²
        if (isHost && players.length >= 2 && allPlayersHaveColors) {
          startGameBtn.style.display = 'inline-block';
        } else {
          startGameBtn.style.display = 'none';
        }
      }
    }

    function leaveRoom() {
      // å…ˆå‘é€é€€å‡ºæˆ¿é—´æ¶ˆæ¯åˆ°æœåŠ¡å™¨
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: "leave_room" }));
        
        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©æœåŠ¡å™¨å¤„ç†é€€å‡ºæ¶ˆæ¯ï¼Œç„¶åå…³é—­è¿æ¥
        setTimeout(() => {
          if (ws) {
            ws.close();
          }
        }, 100);
      }
      
      // æ¸…é™¤è¿æ¥çŠ¶æ€
      currentPlayer = null;
      gameData = null;
      isHost = false;
      roomPlayers = [];
      gameStarted = false;
      playerColors = {};
      availableColors = [];
      selectedColor = null;
      
      // åœæ­¢å¿ƒè·³æ£€æµ‹
      stopHeartbeat();
      
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨
      localStorage.removeItem('monopoly_player_name');
      
      // é‡ç½®UIçŠ¶æ€
      document.getElementById('join-section').style.display = 'block';
      document.getElementById('leave-section').style.display = 'none';
      document.getElementById('player-list-container').style.display = 'none';
      document.getElementById('name').value = '';
      
      log("å·²é€€å‡ºæˆ¿é—´");
    }

    function connect() {
      const nameInput = document.getElementById('name');
      const name = nameInput.value.trim();
      if (!name) {
        alert('è¯·è¾“å…¥åå­—');
        return;
      }
      
      // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰è¿æ¥è®°å½•
      const existingConnection = localStorage.getItem('monopoly_player_name');
      if (existingConnection && existingConnection !== name) {
        const confirmChange = confirm(`æ­¤è®¾å¤‡ä¸Šå·²æœ‰ç©å®¶"${existingConnection}"è¿æ¥ã€‚æ˜¯å¦è¦åˆ‡æ¢åˆ°æ–°ç©å®¶"${name}"ï¼Ÿ\n\næ³¨æ„ï¼šåˆ‡æ¢ç©å®¶å¯èƒ½ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼Œå»ºè®®ä½¿ç”¨ä¸åŒè®¾å¤‡ã€‚`);
        if (!confirmChange) {
          nameInput.value = existingConnection;
          return;
        }
      }
      
      currentPlayer = name;
      // åŠ¨æ€è·å–å½“å‰ä¸»æœºåœ°å€ï¼Œæ”¯æŒå†…ç½‘è®¿é—®
      const host = window.location.hostname || 'localhost';
      const port = window.location.port || '8000';
      ws = new WebSocket(`ws://${host}:${port}/ws/${name}`);

      ws.onopen = () => {
        log("å·²è¿æ¥æœåŠ¡å™¨");
        // è¿æ¥æˆåŠŸåè®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('monopoly_player_name', name);
        
        // éšè—åŠ å…¥æˆ¿é—´åŒºåŸŸï¼Œæ˜¾ç¤ºé€€å‡ºæˆ¿é—´æŒ‰é’®
        document.getElementById('join-section').style.display = 'none';
        document.getElementById('leave-section').style.display = 'block';
        
        startHeartbeat(); // å¯åŠ¨å¿ƒè·³æ£€æµ‹
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };

      ws.onclose = (event) => {
        // æ ¹æ®å…³é—­ä»£ç æ˜¾ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯
        if (event.code === 4001) {
          alert("è¿æ¥è¢«æ‹’ç»ï¼šåŒä¸€è®¾å¤‡åªèƒ½è¿æ¥ä¸€ä¸ªè§’è‰²ï¼\nè¯·ä½¿ç”¨ä¸åŒçš„è®¾å¤‡æˆ–ç­‰å¾…å½“å‰è¿æ¥æ–­å¼€ã€‚");
          localStorage.removeItem('monopoly_player_name');
          log("è¿æ¥è¢«æ‹’ç»ï¼šåŒä¸€è®¾å¤‡åªèƒ½è¿æ¥ä¸€ä¸ªè§’è‰²");
          // æ¢å¤åŠ å…¥æˆ¿é—´ç•Œé¢
          document.getElementById('join-section').style.display = 'block';
          document.getElementById('leave-section').style.display = 'none';
          document.getElementById('player-list-container').style.display = 'none';
          return;
        } else if (event.code === 4002) {
          alert("è¿æ¥è¢«æ‹’ç»ï¼šç©å®¶åå·²å­˜åœ¨ï¼\nè¯·ä½¿ç”¨ä¸åŒçš„åå­—ã€‚");
          log("è¿æ¥è¢«æ‹’ç»ï¼šç©å®¶åå·²å­˜åœ¨");
          // æ¢å¤åŠ å…¥æˆ¿é—´ç•Œé¢
          document.getElementById('join-section').style.display = 'block';
          document.getElementById('leave-section').style.display = 'none';
          document.getElementById('player-list-container').style.display = 'none';
          return;
        } else if (event.code === 4003) {
          alert("è¿æ¥è¢«æ‹’ç»ï¼šæ¸¸æˆå·²å¼€å§‹ï¼Œä¸å…è®¸æ–°ç©å®¶åŠ å…¥ï¼\nè¯·ç­‰å¾…å½“å‰æ¸¸æˆç»“æŸåå†åŠ å…¥ã€‚");
          log("è¿æ¥è¢«æ‹’ç»ï¼šæ¸¸æˆå·²å¼€å§‹");
          // æ¢å¤åŠ å…¥æˆ¿é—´ç•Œé¢
          document.getElementById('join-section').style.display = 'block';
          document.getElementById('leave-section').style.display = 'none';
          document.getElementById('player-list-container').style.display = 'none';
          return;
        }
        
        log("è¿æ¥å…³é—­ï¼Œå‡†å¤‡é‡è¿...");
        stopHeartbeat();
        
        // é¿å…é¢‘ç¹é‡è¿ï¼Œå¢åŠ å»¶è¿Ÿ
        if (!isReconnecting) {
          setTimeout(() => {
            if (currentPlayer && !isReconnecting) {
              startReconnect();
            }
          }, 2000); // 2ç§’åå¼€å§‹é‡è¿
        }
      };

      ws.onerror = (error) => {
        console.error("WebSocketè¿æ¥é”™è¯¯:", error);
        log("è¿æ¥é”™è¯¯");
        stopHeartbeat();
      };
    }

    // å¿ƒè·³æ£€æµ‹å˜é‡
    let heartbeatTimer = null;
    let reconnectTimer = null;
    let isReconnecting = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // å¯åŠ¨å¿ƒè·³æ£€æµ‹
    function startHeartbeat() {
      stopHeartbeat(); // å…ˆåœæ­¢ä¹‹å‰çš„å¿ƒè·³
      heartbeatTimer = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          try {
            ws.send(JSON.stringify({ action: "ping" }));
          } catch (error) {
            console.error("å¿ƒè·³å‘é€å¤±è´¥:", error);
            if (!isReconnecting) {
              startReconnect();
            }
          }
        }
      }, 45000); // å»¶é•¿åˆ°45ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ï¼Œå‡å°‘é¢‘ç‡
    }

    // åœæ­¢å¿ƒè·³æ£€æµ‹
    function stopHeartbeat() {
      if (heartbeatTimer) {
        clearInterval(heartbeatTimer);
        heartbeatTimer = null;
      }
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
    }

    // é‡è¿å‡½æ•°
    function startReconnect() {
      if (isReconnecting || !currentPlayer) return;
      
      isReconnecting = true;
      stopHeartbeat();

      // æ£€æŸ¥æœ¬åœ°è¿æ¥è®°å½•æ˜¯å¦ä¸€è‡´
      const existingConnection = localStorage.getItem('monopoly_player_name');
      if (existingConnection !== currentPlayer) {
        log("æ£€æµ‹åˆ°ç©å®¶åå˜æ›´ï¼Œåœæ­¢é‡è¿");
        isReconnecting = false;
        return;
      }

      function attemptReconnect() {
        if (reconnectAttempts >= maxReconnectAttempts) {
          log(`é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•° (${maxReconnectAttempts})`);
          isReconnecting = false;
          reconnectAttempts = 0;
          // é‡ç½®UIåˆ°åˆå§‹çŠ¶æ€
          document.getElementById('join-section').style.display = 'block';
          document.getElementById('leave-section').style.display = 'none';
          document.getElementById('player-list-container').style.display = 'none';
          localStorage.removeItem('monopoly_player_name');
          currentPlayer = null;
          return;
        }

        reconnectAttempts++;
        log(`æ­£åœ¨å°è¯•é‡è¿... (${reconnectAttempts}/${maxReconnectAttempts})`);
        
        const host = window.location.hostname || 'localhost';
        const port = window.location.port || '8000';
        ws = new WebSocket(`ws://${host}:${port}/ws/${currentPlayer}`);

        ws.onopen = () => {
          log("é‡è¿æˆåŠŸ");
          isReconnecting = false;
          reconnectAttempts = 0;
          
          // é‡è¿æˆåŠŸåä¹Ÿè¦æ›´æ–°UIçŠ¶æ€
          document.getElementById('join-section').style.display = 'none';
          document.getElementById('leave-section').style.display = 'block';
          
          startHeartbeat();
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            handleMessage(msg);
          } catch (error) {
            console.error("æ¶ˆæ¯è§£æå¤±è´¥:", error);
          }
        };

        ws.onclose = (event) => {
          // å¦‚æœæ˜¯è¢«æœåŠ¡å™¨ä¸»åŠ¨æ‹’ç»ï¼Œä¸å†é‡è¿
          if (event.code === 4001 || event.code === 4002 || event.code === 4003) {
            log("é‡è¿è¢«æ‹’ç»ï¼Œåœæ­¢å°è¯•");
            isReconnecting = false;
            reconnectAttempts = 0;
            localStorage.removeItem('monopoly_player_name');
            document.getElementById('join-section').style.display = 'block';
            document.getElementById('leave-section').style.display = 'none';
            document.getElementById('player-list-container').style.display = 'none';
            return;
          }
          
          if (isReconnecting) {
            // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œé¿å…é¢‘ç¹é‡è¿
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000);
            log(`é‡è¿å¤±è´¥ï¼Œ${delay/1000}ç§’åå†æ¬¡å°è¯•...`);
            reconnectTimer = setTimeout(attemptReconnect, delay);
          }
        };

        ws.onerror = (error) => {
          console.error("WebSocketé”™è¯¯:", error);
        };
      }

      // ç«‹å³å¼€å§‹ç¬¬ä¸€æ¬¡é‡è¿å°è¯•
      attemptReconnect();
    }

    // åºŸå¼ƒæ—§çš„reconnectå‡½æ•°ï¼Œç”¨startReconnectæ›¿ä»£
    function reconnect() {
      startReconnect();
    }

    function startGame() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      if (!isHost) {
        alert("åªæœ‰æˆ¿ä¸»å¯ä»¥å¼€å§‹æ¸¸æˆ");
        return;
      }
      if (roomPlayers.length < 2) {
        alert("è‡³å°‘éœ€è¦2åç©å®¶æ‰èƒ½å¼€å§‹æ¸¸æˆ");
        return;
      }
      
      log("æˆ¿ä¸»æ­£åœ¨å¯åŠ¨æ¸¸æˆ...");
      ws.send(JSON.stringify({ action: "start_game" }));
    }

    function rollDice() {
      if (!gameStarted) {
        alert("æ¸¸æˆè¿˜æœªå¼€å§‹");
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }

      // ç«‹å³æ’­æ”¾æ·éª°å­åŠ¨ç”»
      playDiceAnimation();

      ws.send(JSON.stringify({ action: "roll_dice" }));
    }

    // æ–°å¢ï¼šæ’­æ”¾æ·éª°å­åŠ¨ç”»çš„å‡½æ•°
    function playDiceAnimation() {
      const dice1 = document.getElementById('dice1');
      const dice2 = document.getElementById('dice2');
      
      // ä¸¤ä¸ªéª°å­åˆ†åˆ«åšä¸åŒçš„æ—‹è½¬åŠ¨ç”»ï¼Œå¢åŠ éšæœºæ€§
      dice1.style.transition = "transform 1.5s ease-out";
      dice1.style.transform = `rotateX(${360 * 3}deg) rotateY(${360 * 4}deg)`;
      
      dice2.style.transition = "transform 1.5s ease-out";
      dice2.style.transform = `rotateX(${360 * 4}deg) rotateY(${360 * 3}deg)`;
    }

    function buy() {
      if (!gameStarted) {
        alert("æ¸¸æˆè¿˜æœªå¼€å§‹");
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      ws.send(JSON.stringify({ action: "buy_property" }));
    }

    function upgrade() {
      if (!gameStarted) {
        alert("æ¸¸æˆè¿˜æœªå¼€å§‹");
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      ws.send(JSON.stringify({ action: "upgrade_property" }));
    }

    function showFinancialOptions() {
      if (!gameStarted) {
        alert("æ¸¸æˆè¿˜æœªå¼€å§‹");
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      ws.send(JSON.stringify({ action: "get_financial_options" }));
    }

    function endTurn() {
      if (!gameStarted) {
        alert("æ¸¸æˆè¿˜æœªå¼€å§‹");
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„åŠ¨ä½œ
      if (gameData && gameData.pending) {
        const confirmMessage = `æ‚¨æœ‰å¾…å¤„ç†çš„åŠ¨ä½œï¼š${gameData.pending.action}ã€‚\nç¡®å®šè¦è·³è¿‡æ­¤åŠ¨ä½œå¹¶ç»“æŸå›åˆå—ï¼Ÿ`;
        if (!confirm(confirmMessage)) {
          return;
        }
      }
      
      // å‘é€ç»“æŸå›åˆè¯·æ±‚
      ws.send(JSON.stringify({ action: "end_turn" }));
      log("è¯·æ±‚ç»“æŸå›åˆ...");
    }

    function closeFinancialModal() {
      document.getElementById('financial-modal').style.display = 'none';
    }

    function mortgageProperty(propertyName) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      ws.send(JSON.stringify({
        action: "mortgage_property",
        property_name: propertyName
      }));
      closeFinancialModal();
    }

    function redeemProperty(propertyName) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("æœªè¿æ¥æœåŠ¡å™¨");
        return;
      }
      ws.send(JSON.stringify({
        action: "redeem_property",
        property_name: propertyName
      }));
      closeFinancialModal();
    }

    function sellProperty(propertyName) {
      if (confirm(`ç¡®å®šè¦å‡ºå”® ${propertyName} å—ï¼Ÿå‡ºå”®åå°†æ— æ³•æ”¶å›ï¼`)) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("æœªè¿æ¥æœåŠ¡å™¨");
          return;
        }
        ws.send(JSON.stringify({
          action: "sell_property",
          property_name: propertyName
        }));
        closeFinancialModal();
      }
    }

    function handleMessage(msg) {
      // å¤„ç†å¿ƒè·³å“åº”
      if (msg.type === "pong") {
        // æ”¶åˆ°å¿ƒè·³å“åº”ï¼Œè¿æ¥æ­£å¸¸
        return;
      }

      // å¤„ç†æ¸¸æˆå¼€å§‹æ¶ˆæ¯
      if (msg.type === "game_started") {
        log("æ¸¸æˆå¼€å§‹ï¼æ‰€æœ‰ç©å®¶è¿›å…¥æ¸¸æˆç•Œé¢");
        // ä¿å­˜å®Œæ•´çš„æ¸¸æˆæ•°æ®
        gameData = {
          players: msg.players || [],
          properties: msg.properties || [],
          current_player: msg.current_player
        };
        showGame();
        return;
      }

      // å¤„ç†æ¸¸æˆé‡è¿æ¶ˆæ¯
      if (msg.type === "game_reconnect") {
        log(msg.message || "é‡æ–°è¿æ¥åˆ°æ¸¸æˆä¸­");
        // ä¿å­˜å®Œæ•´çš„æ¸¸æˆæ•°æ®
        gameData = {
          players: msg.players || [],
          properties: msg.properties || [],
          current_player: msg.current_player
        };
        showGame();
        return;
      }

      // å¤„ç†ç©å®¶åˆ—è¡¨æ›´æ–°
      if (msg.type === "player_list") {
        updatePlayerList(msg.players, msg.host, msg.player_colors || {}, msg.available_colors || []);
        return;
      }

      // å¤„ç†é¢œè‰²é€‰æ‹©ç»“æœ
      if (msg.type === "color_selected") {
        log(`æˆåŠŸé€‰æ‹©é¢œè‰²: ${msg.color}`);
        selectedColor = msg.color;
        return;
      }

      if (msg.type === "player_left") {
        log(`ç©å®¶ ${msg.player} ç¦»å¼€æ¸¸æˆ`);
        // å¦‚æœæ¸¸æˆè¿˜æ²¡å¼€å§‹ï¼Œæ›´æ–°ç©å®¶åˆ—è¡¨
        if (!gameStarted && msg.remaining_players) {
          updatePlayerList(msg.remaining_players, msg.new_host);
        }
        return;
      }
      if (msg.game_over) {
        log("æ¸¸æˆç»“æŸï¼èƒœè€…: " + msg.winner);
        alert(`æ¸¸æˆç»“æŸï¼èƒœè€…æ˜¯ ${msg.winner}`);
        return;
      }
      if (msg.type === "financial_options") {
        showFinancialOptionsModal(msg);
        return;
      }
      if (msg.type === "mortgage_result" || msg.type === "redeem_result" || msg.type === "sell_result") {
        if (msg.events) {
          msg.events.forEach(e => log("æ“ä½œ: " + e));
        }
        if (msg.players) {
          updatePlayerStats(msg.players);
        }
        return;
      }
      if (msg.type === "buy_result" || msg.type === "upgrade_result") {
        if (msg.events) {
          msg.events.forEach(e => log("æ“ä½œ: " + e));
        }
        if (msg.players) {
          updatePlayerStats(msg.players);
          gameData = msg;
        }
        // ç«‹å³é‡æ–°æ¸²æŸ“æ£‹ç›˜ï¼Œå¦‚æœæœ‰åœ°äº§æ•°æ®çš„è¯
        if (msg.properties && msg.players) {
          renderBoard(msg.players, msg.properties);
          log(`å·²æ›´æ–°æ£‹ç›˜æ˜¾ç¤º - å…±${msg.properties.length}ä¸ªåœ°å—`);
        }
        // æ›´æ–°å½“å‰ç©å®¶æ˜¾ç¤º
        if (msg.current_player) {
          updateCurrentPlayer(msg.current_player);
        }
        return;
      }
      if (msg.type === "turn_ended") {
        if (msg.events) {
          msg.events.forEach(e => log("å›åˆ: " + e));
        }
        if (msg.players) {
          updatePlayerStats(msg.players);
          gameData = msg;
        }
        if (msg.properties) {
          renderBoard(msg.players, msg.properties);
        }
        // æ›´æ–°å½“å‰ç©å®¶æ˜¾ç¤º
        if (msg.current_player) {
          updateCurrentPlayer(msg.current_player);
        }
        return;
      }
      if (msg.type === "error") {
        log("é”™è¯¯: " + msg.message);
        alert("é”™è¯¯: " + msg.message);
        return;
      }
      if (msg.player && msg.dice_total !== undefined) {
        // å¦‚æœä¸æ˜¯å½“å‰ç©å®¶æ·éª°å­ï¼Œä¹Ÿæ’­æ”¾åŠ¨ç”»
        if (msg.player !== currentPlayer) {
          playDiceAnimation();
        }

        // æ˜¾ç¤ºéª°å­ç»“æœä¿¡æ¯
        let diceInfo = `æ€»ç‚¹æ•° ${msg.dice_total}`;
        if (msg.dice_values && msg.dice_values.length === 2) {
          diceInfo = `éª°å­1: ${msg.dice_values[0]}, éª°å­2: ${msg.dice_values[1]} (æ€»è®¡: ${msg.dice_total})`;
        }
        
        log(`${msg.player} æ·éª°å­ ${diceInfo}ï¼Œåˆ°è¾¾ ${msg.landed_on}`);

        // å»¶è¿Ÿæ˜¾ç¤ºæœ€ç»ˆç»“æœï¼Œè®©åŠ¨ç”»å…ˆæ’­æ”¾
        setTimeout(() => {
          if (msg.dice_values && msg.dice_values.length === 2) {
            showDiceFace(msg.dice_values[0], msg.dice_values[1]);
          } else {
            // å…¼å®¹æ—§æ ¼å¼ï¼Œå½“æ€»ç‚¹æ•°é™¤ä»¥2æ˜¾ç¤ºä¸¤ä¸ªéª°å­
            const avg = Math.ceil(msg.dice_total / 2);
            showDiceFace(avg, msg.dice_total - avg);
          }
        }, 1500);

        msg.events.forEach(e => log("äº‹ä»¶: " + e));

        // å¤„ç†å€ºåŠ¡æƒ…å†µ
        if (msg.debt_situation) {
          const debt = msg.debt_situation;
          if (debt.can_recover) {
            log(`âš ï¸ ${debt.player} èµ„é‡‘ä¸è¶³ï¼Œéœ€è¦æŠµæŠ¼æˆ–å‡ºå”®åœ°å—æ¥å¿è¿˜å€ºåŠ¡ï¼`);
            if (debt.player === currentPlayer) {
              alert(`æ‚¨èµ„é‡‘ä¸è¶³ï¼Œéœ€è¦æŠµæŠ¼æˆ–å‡ºå”®åœ°å—æ¥å¿è¿˜ $${debt.debt} çš„å€ºåŠ¡ï¼`);
              showFinancialOptions(); // è‡ªåŠ¨æ‰“å¼€è´¢åŠ¡ç®¡ç†ç•Œé¢
            }
          } else {
            log(`ğŸ’€ ${debt.player} å·²ç ´äº§ï¼`);
          }
        }

        // ä¸è¦è¿™é‡Œæ›´æ–°å½“å‰ç©å®¶ï¼Œå› ä¸ºåœ¨ä¸‹é¢ä¼šç»Ÿä¸€å¤„ç†
        // updateCurrentPlayer(msg.player);
      }
      if (msg.pending) {
        log(`æ“ä½œæç¤º: ${msg.pending.action} (${msg.pending.property})`);
      }
      if (msg.players && msg.properties) {
        gameData = msg;
        renderBoard(msg.players, msg.properties);
        updatePlayerStats(msg.players);
        
        // æ›´æ–°å½“å‰ç©å®¶æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if (msg.current_player) {
          updateCurrentPlayer(msg.current_player);
        }
      }
    }

    function showFinancialOptionsModal(data) {
      const modal = document.getElementById('financial-modal');
      const mortgageableList = document.getElementById('mortgageable-list');
      const redeemableList = document.getElementById('redeemable-list');
      const sellableList = document.getElementById('sellable-list');

      // æ¸…ç©ºåˆ—è¡¨
      mortgageableList.innerHTML = '';
      redeemableList.innerHTML = '';
      sellableList.innerHTML = '';

      // å¡«å……å¯æŠµæŠ¼åœ°å—
      if (data.mortgageable_properties && data.mortgageable_properties.length > 0) {
        data.mortgageable_properties.forEach(prop => {
          const button = document.createElement('button');
          button.textContent = `${prop.name} (è·å¾— $${prop.mortgage_value})`;
          button.onclick = () => mortgageProperty(prop.name);
          button.style.margin = '5px';
          button.style.backgroundColor = '#4CAF50';
          button.style.color = 'white';
          button.style.padding = '5px 10px';
          button.style.border = 'none';
          button.style.borderRadius = '3px';
          mortgageableList.appendChild(button);
        });
      } else {
        mortgageableList.textContent = 'æ— å¯æŠµæŠ¼åœ°å—';
      }

      // å¡«å……å¯èµå›åœ°å—
      if (data.redeemable_properties && data.redeemable_properties.length > 0) {
        data.redeemable_properties.forEach(prop => {
          const button = document.createElement('button');
          button.textContent = `${prop.name} (èŠ±è´¹ $${prop.redeem_cost})`;
          button.onclick = () => redeemProperty(prop.name);
          button.style.margin = '5px';
          button.style.backgroundColor = '#2196F3';
          button.style.color = 'white';
          button.style.padding = '5px 10px';
          button.style.border = 'none';
          button.style.borderRadius = '3px';
          redeemableList.appendChild(button);
        });
      } else {
        redeemableList.textContent = 'æ— å¯èµå›åœ°å—';
      }

      // å¡«å……å¯å‡ºå”®åœ°å—
      if (data.sellable_properties && data.sellable_properties.length > 0) {
        data.sellable_properties.forEach(prop => {
          const button = document.createElement('button');
          button.textContent = `${prop.name} (è·å¾— $${prop.sell_value})`;
          button.onclick = () => sellProperty(prop.name);
          button.style.margin = '5px';
          button.style.backgroundColor = '#f44336';
          button.style.color = 'white';
          button.style.padding = '5px 10px';
          button.style.border = 'none';
          button.style.borderRadius = '3px';
          sellableList.appendChild(button);
        });
      } else {
        sellableList.textContent = 'æ— å¯å‡ºå”®åœ°å—';
      }

      modal.style.display = 'block';
    }

    function showDiceFace(dice1Value, dice2Value) {
      const dice1 = document.getElementById('dice1');
      const dice2 = document.getElementById('dice2');
      
      const rot1 = diceRotations[dice1Value];
      const rot2 = diceRotations[dice2Value];
      
      dice1.style.transition = "transform 1s ease-out";
      dice1.style.transform = `rotateX(${rot1.x}deg) rotateY(${rot1.y}deg)`;
      
      dice2.style.transition = "transform 1s ease-out";
      dice2.style.transform = `rotateX(${rot2.x}deg) rotateY(${rot2.y}deg)`;
    }

    function updateCurrentPlayer(playerName) {
      const currentPlayerDiv = document.getElementById('current-player');
      currentPlayerDiv.textContent = `å½“å‰ç©å®¶: ${playerName}`;
    }

    function updatePlayerStats(players) {
      const statsDiv = document.getElementById('player-stats');
      statsDiv.innerHTML = '<h4>ç©å®¶çŠ¶æ€</h4>';
      players.forEach((player, index) => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-stat';
        // ä½¿ç”¨ç©å®¶é€‰æ‹©çš„é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é¢„å®šä¹‰é¢œè‰²
        const playerColor = playerColors[player.name] || predefinedColors[index] || '#cccccc';
        playerDiv.style.borderLeft = `4px solid ${playerColor}`;
        playerDiv.innerHTML = `
        <span><strong>${player.name}</strong></span>
        <span>$${player.money}</span>
      `;
        statsDiv.appendChild(playerDiv);
      });
    }

    function renderBoard(players, properties) {
      // æ¸…é™¤ç°æœ‰çš„åœ°å—å…ƒç´ ï¼ˆä¿ç•™ä¸­å¤®åŒºåŸŸï¼‰
      const existingTiles = document.querySelectorAll('.tile, .corner-tile');
      existingTiles.forEach(tile => tile.remove());

      const board = document.getElementById('board');

      // åˆ›å»ºåœ°å—
      boardPositions.forEach((boardPos, i) => {
        const property = properties[i] || { name: boardPos.name, cost: 0, owner: null, houses: 0 };

        const div = document.createElement('div');
        div.className = boardPos.pos;
        div.setAttribute('data-position', i);

        // è®¾ç½®èƒŒæ™¯é¢œè‰²
        if (property.owner) {
          const ownerIndex = players.findIndex(p => p.name === property.owner);
          const ownerColor = playerColors[property.owner] || predefinedColors[ownerIndex] || '#cccccc';
          div.style.background = `linear-gradient(145deg, ${ownerColor}, ${ownerColor}88)`;
        } else if (boardPos.special) {
          div.style.background = 'linear-gradient(45deg, #ffd700, #ffed4e)';
        } else {
          div.style.background = 'linear-gradient(145deg, #ffffff, #f0f0f0)';
        }

        // åˆ›å»ºåœ°å—å†…å®¹
        div.innerHTML = `
        <div class="property-name">${property.name}</div>
        <div class="property-info">
          ${property.cost > 0 ? `<div class="property-price">$${Array.isArray(property.cost) ? property.cost[0] : property.cost}</div>` : ''}
          ${property.owner ? `<div style="color: #e74c3c;">æ‹¥æœ‰è€…: ${property.owner}</div>` : ''}
          ${property.is_mortgaged ? `<div style="color: #ff9800; font-weight: bold;">å·²æŠµæŠ¼</div>` : ''}
        </div>
        ${property.houses > 0 ? `<div class="houses-indicator">ğŸ Ã—${property.houses}</div>` : ''}
      `;

        // æ·»åŠ ç©å®¶æ ‡è®°
        const playersHere = players ? players.filter(p => p.position === i) : [];
        if (playersHere.length > 0) {
          const playerToken = document.createElement('div');
          playerToken.className = 'player-token';
          playerToken.innerHTML = playersHere.map((p, idx) => {
            const playerIndex = players.findIndex(player => player.name === p.name);
            const playerColor = playerColors[p.name] || predefinedColors[playerIndex] || '#cccccc';
            return `<span style="color: ${playerColor};">â—</span>`;
          }).join('');
          div.appendChild(playerToken);
        }

        board.appendChild(div);
      });
    }

    // åˆå§‹åŒ–æ£‹ç›˜ - é¡µé¢åŠ è½½æ—¶å°±æ˜¾ç¤ºæ£‹ç›˜
    function initializeBoard() {
      const defaultProperties = boardPositions.map((pos, index) => ({
        name: pos.name,
        cost: pos.prices,
        owner: null,
        houses: 0
      }));

      renderBoard([], defaultProperties);
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', async function () {
      // æ˜¾ç¤ºæˆ¿é—´ç­‰å¾…é¡µé¢
      showLobby();
      
      // å…ˆåŠ è½½æ£‹ç›˜æ•°æ®
      await loadBoardData();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç©å®¶å
      const savedPlayerName = localStorage.getItem('monopoly_player_name');
      if (savedPlayerName) {
        const nameInput = document.getElementById('name');
        nameInput.value = savedPlayerName;
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        const joinSection = document.getElementById('join-section');
        const existingPlayerHint = document.createElement('div');
        existingPlayerHint.style.color = '#e67e22';
        existingPlayerHint.style.fontSize = '14px';
        existingPlayerHint.style.marginBottom = '10px';
        existingPlayerHint.innerHTML = `âš ï¸ æ£€æµ‹åˆ°æ­¤è®¾å¤‡ä¸Šæ¬¡è¿æ¥çš„ç©å®¶åï¼š"${savedPlayerName}"<br>å¦‚éœ€ä½¿ç”¨æ–°åå­—ï¼Œè¯·å…ˆæ¸…é™¤åŸæœ‰è®°å½•`;
        
        const clearButton = document.createElement('button');
        clearButton.textContent = 'æ¸…é™¤è®°å½•';
        clearButton.style.marginLeft = '10px';
        clearButton.style.padding = '5px 10px';
        clearButton.style.fontSize = '12px';
        clearButton.style.background = '#e74c3c';
        clearButton.style.color = 'white';
        clearButton.style.border = 'none';
        clearButton.style.borderRadius = '4px';
        clearButton.style.cursor = 'pointer';
        clearButton.onclick = () => {
          localStorage.removeItem('monopoly_player_name');
          nameInput.value = '';
          existingPlayerHint.remove();
          // ç¡®ä¿UIçŠ¶æ€æ­£ç¡®
          document.getElementById('join-section').style.display = 'block';
          document.getElementById('leave-section').style.display = 'none';
          document.getElementById('player-list-container').style.display = 'none';
          log("å·²æ¸…é™¤æœ¬åœ°è¿æ¥è®°å½•");
        };
        
        existingPlayerHint.appendChild(clearButton);
        joinSection.insertBefore(existingPlayerHint, joinSection.firstChild);
      }
    });

    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState === 'visible') {
        // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€
        if (ws && ws.readyState !== WebSocket.OPEN && currentPlayer && !isReconnecting) {
          log("é¡µé¢é‡æ–°æ¿€æ´»ï¼Œæ£€æŸ¥è¿æ¥...");
          startReconnect();
        }
      }
    });

    // é˜²æ­¢é¡µé¢æ„å¤–å…³é—­æ—¶çš„æ¸…ç†
    window.addEventListener('beforeunload', function () {
      stopHeartbeat();
      isReconnecting = false;
      if (ws && ws.readyState === WebSocket.OPEN) {
        // å°è¯•å‘é€é€€å‡ºæ¶ˆæ¯
        try {
          ws.send(JSON.stringify({ action: "leave_room" }));
        } catch (error) {
          console.error("å‘é€é€€å‡ºæ¶ˆæ¯å¤±è´¥:", error);
        }
        ws.close();
      }
    });
  </script>

</body>

</html>